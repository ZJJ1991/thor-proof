"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("./types");
const crypto_1 = require("./crypto");
const rlp = require('rlp');
class Transaction {
    constructor(body) {
        validateBody(body);
        this.body = body;
    }
    get signingHash() {
        let data = rlp.encode(rlpList(this.body));
        return crypto_1.blake2b256(data);
    }
    get id() {
        return crypto_1.blake2b256(this.signingHash.buffer, this.signer.buffer);
    }
    get signer() {
        if (!this.signature)
            throw new Error('signature missing');
        return crypto_1.ecrecover(this.signingHash, this.signature);
    }
    get intrinsicGas() {
        const txGas = 5000;
        const clauseGas = 16000;
        const clauseGasContractCreation = 48000;
        if (this.body.clauses.length === 0)
            return txGas + clauseGas;
        return this.body.clauses.reduce((sum, c) => {
            sum += dataGas(c.data.buffer);
            if (c.to)
                sum += clauseGas;
            else
                sum += clauseGasContractCreation;
            return sum;
        }, txGas);
    }
    gasPrice(baseGasPrice) {
        let bgp = baseGasPrice.toBigNumber();
        let extra = bgp
            .multipliedBy(this.body.gasPriceCoef)
            .dividedToIntegerBy(0xff);
        return types_1.BigInt.from(bgp.plus(extra));
    }
    sign(privateKey) {
        this.signature = crypto_1.ecsign(this.signingHash, privateKey);
    }
    encode() {
        if (!this.signature)
            throw new Error("signature missing");
        let list = rlpList(this.body);
        list.push(this.signature.buffer);
        let data = rlp.encode(list);
        return new types_1.Bytes(data);
    }
    static decode(raw) {
        let list = decodeList(rlp.decode(raw.buffer), 10);
        let tx = new Transaction({
            chainTag: decodeNumber(list[0]),
            blockRef: new types_1.Bytes(decodeBigInt(list[1]).buffer),
            expiration: decodeNumber(list[2]),
            clauses: decodeClauses(list[3]),
            gasPriceCoef: decodeNumber(list[4]),
            gas: decodeBigInt(list[5]),
            dependsOn: decodeBytes32OrNull(list[6]),
            nonce: decodeBigInt(list[7]),
            reserved: decodeList(list[8])
        });
        tx.signature = new types_1.Bytes(decodeBuffer(list[9]));
        return tx;
    }
}
exports.Transaction = Transaction;
function decodeClauses(data) {
    return decodeList(data).map(v => {
        let clauseData = decodeList(v, 3);
        return {
            to: decodeAddressOrNull(clauseData[0]),
            value: new types_1.BigInt(decodeBuffer(clauseData[1])),
            data: new types_1.Bytes(decodeBuffer(clauseData[2]))
        };
    });
}
function rlpList(body) {
    return [
        body.chainTag,
        body.blockRef.trimLeft().buffer,
        body.expiration,
        body.clauses.map(clause => {
            return [
                clause.to ? clause.to.buffer : "",
                clause.value.buffer,
                clause.data.buffer
            ];
        }),
        body.gasPriceCoef,
        body.gas.buffer,
        body.dependsOn ? body.dependsOn.buffer : "",
        body.nonce.buffer,
        body.reserved,
    ];
}
function validateBody(body) {
    mustUintN(body.chainTag, 8, 'chainTag: must be uint8');
    mustUintN(body.expiration, 32, 'expiration: must be uint32');
    mustUintN(body.gasPriceCoef, 8, 'gasPriceCoef: must be uint8');
    mustUintN(body.gas, 64, 'gas: must be uint64');
    if (body.blockRef.buffer.length > 8)
        throw new Error('blockRef: out of range');
    if (body.nonce.buffer.length > 8)
        throw new Error('nonce: out of range');
}
function mustUintN(num, bit, msg) {
    if (typeof num === 'number') {
        if (!Number.isInteger(num) || num < 0 || num >= Math.pow(2, bit))
            throw new Error(msg);
    }
    else {
        if (num.buffer.length * 8 > bit)
            throw new Error(msg);
    }
}
function decodeBigInt(data) {
    let buf = decodeBuffer(data);
    let bi = new types_1.BigInt(buf);
    if (bi.buffer.length != buf.length)
        throw new Error('non-canonical integer (leading zero bytes) for integer');
    return bi;
}
function decodeNumber(data) {
    let bi = decodeBigInt(data);
    if (bi.buffer.length * 8 > 53)
        throw new Error('unable to safely decode to number');
    return bi.toBigNumber().toNumber();
}
function decodeBuffer(data) {
    if (!Buffer.isBuffer(data))
        throw new Error('buffer expected');
    return data;
}
function decodeBytes32OrNull(data) {
    let buf = decodeBuffer(data);
    if (buf.length == 0)
        return null;
    if (buf.length != 32)
        throw new Error('bytes32 expected');
    return new types_1.Bytes32(buf);
}
function decodeList(data, elemCount) {
    if (!Array.isArray(data))
        throw new Error('list expected');
    if (elemCount !== undefined) {
        if (data.length !== elemCount)
            throw new Error('list element count incorrect');
    }
    return data;
}
function decodeAddressOrNull(data) {
    let buf = decodeBuffer(data);
    if (buf.length == 0)
        return null;
    if (buf.length != 20)
        throw new Error('address expected');
    return new types_1.Address(buf);
}
function dataGas(data) {
    const zgas = 4;
    const nzgas = 68;
    return data.reduce((sum, cur) => {
        if (cur)
            return sum + nzgas;
        return sum + zgas;
    }, 0);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL3R4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXlEO0FBQ3pELHFDQUF3RDtBQUN4RCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7QUFFMUI7SUFJSSxZQUFZLElBQXNCO1FBQzlCLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNsQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtJQUNwQixDQUFDO0lBRUQsSUFBSSxXQUFXO1FBQ1gsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7UUFDekMsT0FBTyxtQkFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzNCLENBQUM7SUFFRCxJQUFJLEVBQUU7UUFDRixPQUFPLG1CQUFVLENBQ2IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUNyQixDQUFBO0lBQ0wsQ0FBQztJQUVELElBQUksTUFBTTtRQUNOLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUztZQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtRQUV4QyxPQUFPLGtCQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdEQsQ0FBQztJQUVELElBQUksWUFBWTtRQUNaLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQTtRQUNsQixNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUE7UUFDdkIsTUFBTSx5QkFBeUIsR0FBRyxLQUFLLENBQUE7UUFFdkMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQztZQUM5QixPQUFPLEtBQUssR0FBRyxTQUFTLENBQUE7UUFFNUIsT0FB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